# Аутентификация WEB-приложений
- [Home](/)

___
# toc 
- [Фундаментальные концепции](#фундаментальные-концепции)
- [Регистрация](#регистрация)
- [Вход в систему](#вход-в-систему)
- [Запомни меня](#запомни-меня)
- [Изменение деталей аккаута](#изменение-деталей-аккаута)
- [Сброс пароля](#сброс-пароля)
- [Выход из системы](#выход-из-системы)
- [Дополнительные меры](#дополнительные-меры)

___
# Фундаментальные концепции

## HTTPS
1. __Authenticity__ - гарантирует подлинность запрашиваемого интернет ресурса
2. __Integrity__ - защищает от изменения переданных и полученных данных (Man In The Middle)
3. __Confidentiality__ - защищает от прослушивания (Eavesdropping)

## Распространенные атаки
1. __Brute force__ - перебор возможных логинов и паролей
2. __Account enumeration attack__ - возможность установить является ли атакуемый пользователем данного сайта путем анализа ответов с сервера.
3. __Cross site request forgery__ - атака при которой пользователь переходит по ссылке, предоставляемой хакером, ведущей на сайт хакера и выполняющей запросы от имени пользователя.

___
# Хранение паролей

1. Хранение хешей паролей. Для того чтобы воостановить из хеша атакующий может использовать заранее сгенеренные данные (радужные таблицы)
2. Использование соли. Соль случайная и для каждого аккаунта хранится в базе вместе с хешем пароля.
3. Использование криптостойких алгоритмов. Правильно использовать __PBKDF2__, __scrypt__, __bcrypt__._

## Криптографическое хеширование.
- __необратимость__
- __коллизии__
    - __1 рода__ - _для конкретно хеша подбор значения с таким же хешем_
    - __2 рода__ - _подбор любой пары значений с одинаковым хешем_

## Плохие практики

Подход          | Проблема
------------    | -------------
Хранение паролей в открытом виде | _Есть потенциальная возможность засветить пароль. Пользователи часто используют одинаковые пароли к разным сайтам. Тогда все аккаунты с одинаковыми паролями могут быть скомпроментированы_
Хранение в зашифрованном виде | _Есть возможность похитить ключ для расширования (особенно если атака изнутри системы). В этом случае становится эквивалентно хранению в открытом виде_
Пересылка долгоживущих паролей по почте | _SMTP небезопасный протокол. Пароли могут быть похищены. Возможность посторонним лицам доступиться к почтовому ящику через социальную инженерию_
Хеширование без соли | _возможность использования готовых радужных таблиц_
Хеширование с одной и той же солью  | _возможность использования радужных таблиц сгенеренных под конкретную базу_
Хеширование не достаточной криптоской хеш функцией  | _Взлом некриптостойких ключей за исчислимое время. Не использовать __MD5__, __SHA_1__._

___
Гайд от [OWASP](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)

___
# Регистрация

## Выбор между использованием почты для логина или отдельного поля
Использование почты          | Отдельное поле для имени пользователя
------------    | -------------
+ проще запомнить | + отображение в интерфейсе не приводит к компроментации почты
+ не нужно дополнительного поля | + возможность отказаться от функциональности смены имени
+ уникально для пользователя |  + возможность заводить несколько аккаутов для одной почты
- иногда может быть не уникально (одна корпоративная почта на несколько пользователей) | - сброс пароля трудно реализуем при использовании разных почтовых ящиков для одного аккаунта
- может изменяться (нужен механизм смены почтового ящика) | - необходимо реализовать механизм восстановления имени

## Email в качестве имени пользователя

1. проверка пароля
    1. ограничение по минимальной длине (сервер и клиент)
    2. требование использовать разнообразные символы (сервер и клиент)
    3. НЕ ограничивать по максимальной длине
    4. НЕ ограничивать по используемым символам
    5. хорошая практика проверка пароля по словарю часто используемых паролей (сервер) 
2. после регистрации
    1. после регистрации нельзя давать полный доступ к функциональности
    1. аккаунт должен быть подтвержден 
    2. возможен вариант с предоставлением частичной функциональности
3. подтверждение
    1. ограниченно время жизни (1 час)
    2. должен чиститься при удачной попытке
    3. должен чиститься если запрашивается повторно
    4. активирует аккаунт через get запрос
4. при попытке зарегистрировать пользователя с той же почтой необходимо
    1. отвечать стандартным ответом (предотвращение account enumeration)
    2. отправлять пользователю письмо что кто-то пытается создать аккаунт с его почтой
5. пресечение попыток автоматизации регистрации
    1. использования Captcha

## Плохие практики

Подход          | Проблема
------------    | -------------
ограничение на длинну пароля | _безпричинное снижение безопасности системы. Это ограничение призвано ограничить место в б.д. для хранения пароля, но не имеет смысла т.к. при правильном подходе в базе хранится не сам пароль, а хеш ограниченной длинны_
ограничение на используемые в пароле символы| _идея что в пароле может быть вредоносный код. Но она безосновательно т.к. сам пароль нигде не выводится и не исполняется_
запрет на вставку из клипборда в поле пароля | _затрудняет использования менеджера паролей_
сообщение о том что пользователь с указанными именим уже зарегистрирован | расскрытие информации о зарегистрированных пользователях.
нет ограничений на частоту запросов регистрации | возможность account enumeration. Нагрузка на систему рассылку почты что может привести к добавлению почты в спам

___
# Вход в систему

Вход в систему реализуется посредством установки авторизационных куки пользователю
- в куки хранится информация идентифицирующая пользователя, которую нельзя подделать
- для куки устанавливается HttpOnly - нельзя читать и модифицировать из JS
- для куки устанавливается Secure - могут передаваться только через HTTPS

## Обработка неудачных входов

Правильные меры | Проблемные меры 
------------    | -------------
деградация сервиса (длительность входа при неудачных попытках логина увеличивающаяся экспоненциально) | _Блокировка аккаута (возможность DOS атаки на пользователя)_
логирование событий | _Ограничение по IP(не работает против ботнет атак и атак под tor'ом и можно заблокировать других пользователей под этим ip)_
| _ограничение запросов с выставленным куки (атакующий может убрать куки из запроса)_

## Ограничения создания нескольких одновременных сеансов
Для того чтобы ограничить возможность одновременно логина под одним аккаунтом необходимо дополнительно хранить состояния сессии на сервере

### Для этого необходимо реализовать

- запрет одновременной работы
- выкидывать из сессии при попытке одновременного логина

### Минусы

- необходим механизм для разлогирования пользователя
- при этом сессия может иметь не сохраненные данные

! Если нет особых требований бизнеса лучше не имплементировать запрет нескольких сессий под одним аккаутом

## Логгирование событий

- время в UTC
- сообщение 
- IP
- хедеры запроса

## Дополнительные меры

- хорошо извещать пользователя о попытке входа из другой локации
- предоставлять пользователю информацию о попытках логина в его аккаунт (прим. гитхаб)
- использование другого канала для логина - 2FA. Сильно усложняет жизнь атакующему

## Плохие практики

Подход          | Проблема
------------    | -------------
вывод что данный пользователь не зарегистрирован | _возможность account enumeration_

___
# Запомни меня
+ Идет на встречу пользователю
- Увеличивает риск кражи токена

Правильная имплементация: увеличение длительности куки или токена

Подход          | Проблема
------------    | -------------
хранить пароль и логин на клиенте и авторизовать пользователя когда токен просрочен | _атакующий достаточно легко может украсть логин и пароль_

___
# Изменение деталей аккаута

## Какие параметры интересны атакующему
- _пароль_- захват учетной записи
- _почта_- захват учетной записи
- _идентификационные данные_- (номер документов и т.д.) могут использоваться для верификации при попытке подтвердить что является владельцем
- _номера кредитных карт_- также могут использоваться для верификации

## Правильный подход
1. при смене почты либо пароля запрашивать пароль. В том случае если компьютер остается залогиненый достаточно легко угнать учетку 
2. при смене пароля отсылать сообщение на почту что был произведена смена пароля с предложением в случае взлома немедленно сбросить пароль
3. отсылать почту для любых действий с изменениями чувствительных параметров аккаута в том числе и добавление ключей для достпу к апи
4. при изменении почтового ящика необходимо отправлять сообщение для подтверждения на старый почтовый ящик. Для того чтобы у мошенника не было возможности 
полностью угнать аккаут (пока у пользователя остается старый почтовый ящик)

___
# Сброс пароля

Правильные меры | Проблемные меры 
------------    | -------------
Дополнительная защита: вопросы при попытке установить новый пароль. Необходимо правильно подбирать вопросы чтобы не изменялся со временем, было множество допустимых вариантов и трудно было социально инженерить | Отправка текущего пароля (видимо пароль хранится в plain text)- возможность компроментации
Ответ должен быть одинаковым чтобы предотвратить account enumeration  | Отправка нового пароля (возможность атаки dos) 
Если пользователь не зарегистрирован то можно отсылать почту что кто-то пытается сбросить пароль для сайта (спросить у пользователя может он зарегистрирован с другим ящиком | подсказки к паролям - дополнительная возможность для атакующего подобрать пароль
Использовать анти аутомэйшн против брут форса |

___
# Выход из системы

1. Реализуются с помощью простановки клиенту пустых проэкспайренных авторизационных куки.
2. При таком подходе куки удаляются только на клиенте. Если сохранить их то можно зайти после выхода. По этой причине лучше не использовать куки с долгим периодом жизни тк при их краже они надолго скомпроментированы
3. Лучше не использовать GET запрос и применять CSRF токен. Если этого не делать то атакующий легко может проэксплуатировать это разлогинивая пользователя через CSRF.

Хранение состояния сессии на сервере

+ возможно реализовать механизм разлогивания админом
- дополнительная работа при реализации


# Дополнительные меры

- Вынести аутентификацию наружу (_OAUTH_) - уменьшение расходов на разработку
- Использовать _WAF_ (пропускает трафик через себя и фильтрует атаки)
- _2FA_. Любые изменения через два канала. Появляется некоторая проблема т.к. для любого действия нужны оба фактора. Возможная атака когда атакующий захватывает аккаунт и устанавливает 2FA. Пользователь не может войти и даже сбросить пароль и пользователь лишается доступа. Для предотвращения можно использовать период в несколько дней до введения 2FA.
- Для предотвращения возможно атаки изнутри использовать принцип наименьших привилегий (_Principle of least privilege_)
- Везде использовать _SSL_ (+ string-transport-security header)

___
по курсу Pluralsight [secure-account-management-fundamentals](https://app.pluralsight.com/library/courses/secure-account-management-fundamentals/table-of-contents)
